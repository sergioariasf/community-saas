# LecciÃ³n 1.4: Sistema de Roles y Permisos

## ðŸ“‹ Objetivo de la LecciÃ³n

Implementar un **sistema de roles y permisos** para el SaaS de gestiÃ³n de comunidades:

- Definir roles de usuario (Admin, Manager, Resident)
- Crear middleware de autorizaciÃ³n
- Implementar permisos granulares por funcionalidad
- Modificar UI segÃºn los permisos del usuario

## ðŸŽ¯ Roles que Vamos a Crear

### **ðŸ‘‘ ADMIN**

- **Acceso total** a todas las funcionalidades
- Puede crear, editar y eliminar cualquier comunidad
- Gestiona usuarios y asigna roles
- Acceso a analytics y configuraciÃ³n global

### **ðŸ¢ MANAGER**

- **Gestiona UNA comunidad especÃ­fica**
- CRUD completo de su comunidad asignada
- Gestiona residents de su comunidad
- Ve reportes de su comunidad

### **ðŸ  RESIDENT**

- **Solo lectura** de informaciÃ³n bÃ¡sica
- Ve datos de SU comunidad
- Puede crear incidencias
- No puede editar datos de la comunidad

## ðŸ”§ Arquitectura de la ImplementaciÃ³n

### **1. Tabla de Roles en Supabase**

```sql
-- Nueva tabla: user_roles
CREATE TABLE user_roles (
id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE,
community_id uuid REFERENCES communities(id) ON DELETE CASCADE,
role text NOT NULL CHECK (role IN ('admin', 'manager', 'resident')),
created_at timestamp DEFAULT now(),
UNIQUE(user_id, community_id)
);
```

### **2. Hook de Permisos**

```typescript
// hooks/usePermissions.ts
const usePermissions = (communityId?: string) => {
  // Devuelve permisos del usuario actual
  return {
    canCreate: boolean,
    canEdit: boolean,
    canDelete: boolean,
    isAdmin: boolean,
    isManager: boolean,
    isResident: boolean,
  };
};
```

### **3. Middleware de AutorizaciÃ³n**

```typescript
// middleware/withAuth.ts
const withAuth = (requiredRole: Role) => {
  // Wrapper para proteger Server Actions
  return (action: ServerAction) => {
    // Verifica permisos antes de ejecutar
  };
};
```

### **4. Componentes Condicionales**

```typescript
// Mostrar botones segÃºn permisos
{
  canEdit && <EditButton />;
}
{
  canDelete && <DeleteButton />;
}
{
  isAdmin && <AdminPanel />;
}
```

## ðŸ“Š Casos de Uso por Rol

### **Escenario ADMIN:**

- Ve TODAS las comunidades del sistema
- Puede crear/editar/eliminar cualquier comunidad
- Gestiona roles de usuarios
- Acceso a configuraciÃ³n global

### **Escenario MANAGER:**

- Ve SOLO la comunidad que gestiona
- CRUD completo de SU comunidad
- Gestiona residents de su comunidad
- Dashboard con mÃ©tricas de su comunidad

### **Escenario RESIDENT:**

- Ve SOLO informaciÃ³n de SU comunidad (read-only)
- Puede crear incidencias
- Ve avisos y comunicados
- No puede modificar datos

## ðŸŽ¨ Cambios en la UI

### **Navigation Menu:**

- **Admin:** Ve "Todas las Comunidades", "Usuarios", "Config"
- **Manager:** Ve "Mi Comunidad", "Residents", "Reportes"
- **Resident:** Ve "Mi Comunidad", "Mis Incidencias"

### **Community List:**

- **Admin:** Ve todas + botones CREATE/EDIT/DELETE
- **Manager:** Ve solo la suya + botones EDIT
- **Resident:** Ve solo la suya + sin botones de acciÃ³n

### **Community Detail:**

- **Admin/Manager:** Botones "Editar" y "Eliminar"
- **Resident:** Solo vista de lectura

## ðŸ”„ Flujo de ImplementaciÃ³n

### **Paso 1:** Crear tabla `user_roles` en Supabase

### **Paso 2:** Seedear datos de prueba (admin, manager, resident)

### **Paso 3:** Crear hook `usePermissions`

### **Paso 4:** Crear middleware de autorizaciÃ³n

### **Paso 5:** Modificar Server Actions con verificaciÃ³n de permisos

### **Paso 6:** Actualizar componentes con renderizado condicional

### **Paso 7:** Testear cada rol exhaustivamente

## ðŸ§ª Casos de Prueba

### **Test como ADMIN:**

1. Login como admin
2. Ve todas las comunidades
3. Puede crear nueva comunidad
4. Puede editar cualquier comunidad
5. Puede eliminar cualquier comunidad

### **Test como MANAGER:**

1. Login como manager
2. Ve solo SU comunidad asignada
3. Puede editar su comunidad
4. NO puede ver otras comunidades
5. NO puede eliminar comunidades

### **Test como RESIDENT:**

1. Login como resident
2. Ve solo informaciÃ³n de SU comunidad
3. NO ve botones de editar/eliminar
4. Puede ver detalles pero no modificar

## ðŸ“š Conceptos que AprenderÃ¡s

- **Row Level Security (RLS)** avanzado con roles
- **Authorization middleware** en Server Actions
- **Conditional rendering** basado en permisos
- **Multi-tenant architecture** con roles
- **React hooks** para gestiÃ³n de estado de permisos
- **Database design** para sistemas de roles

## ðŸŽ¯ Resultado Final

Al completar esta lecciÃ³n tendrÃ¡s:

- âœ… Sistema de roles completo (admin/manager/resident)
- âœ… Middleware de autorizaciÃ³n funcionando
- âœ… UI que cambia segÃºn permisos del usuario
- âœ… RLS configurado correctamente en Supabase
- âœ… Casos de prueba para cada rol validados

---

**Â¡Vamos a construir un sistema de permisos robusto para tu SaaS!** ðŸš€

#âœ… Sistema de Roles Completado:

- Roles implementados: admin, manager, resident
- Middleware de autorizaciÃ³n: Protege Server Actions
- Hook usePermissions: Gestiona permisos en cliente
- UI condicional: Botones segÃºn permisos del usuario
- Base de datos sincronizada: RLS + user_roles funcionando

ðŸŽ¯ Funcionalidades verificadas:

- CRUD completo con permisos granulares
- Login/auth funcionando correctamente
- Server Actions ejecutÃ¡ndose sin errores
- UI adaptÃ¡ndose segÃºn rol del usuario
