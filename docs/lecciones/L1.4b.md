# üìö Lecci√≥n 1.4b: Sistema de Gesti√≥n de Usuarios

## üéØ **Objetivo**
Implementar un sistema completo de gesti√≥n de usuarios que permita a los administradores crear, editar, eliminar usuarios y gestionar sus roles de manera granular.

## üèóÔ∏è **¬øPor qu√© es importante?**
Despu√©s de implementar el sistema de roles y permisos, necesitamos una interfaz administrativa para gestionar usuarios. Sin esto, solo podr√≠amos modificar usuarios directamente en la base de datos, lo cual no es pr√°ctico para un SaaS.

## üìã **Funcionalidades Implementadas**

### 1. **CRUD Completo de Usuarios**
- **Listar usuarios** con informaci√≥n de roles y comunidades
- **Crear nuevos usuarios** con asignaci√≥n de roles
- **Editar roles** de usuarios existentes
- **Eliminar usuarios** con confirmaci√≥n de seguridad

### 2. **Server Actions Seguras**
```typescript
// /src/data/anon/users.ts
export const createUserAction = authActionClient
  .schema(createUserSchema)
  .action(async ({ parsedInput }) => {
    await requirePermission('admin'); // üîê Solo admin puede crear
    
    const { email, password, roles } = parsedInput;
    const supabase = createSupabaseClient();

    // 1. Crear usuario en Supabase Auth
    const { data: authUser, error: authError } = await supabase.auth.admin.createUser({
      email,
      password,
      email_confirm: true
    });

    // 2. Asignar roles al usuario
    const rolePromises = roles.map(role => 
      supabase.from('user_roles').insert({
        user_id: authUser.user.id,
        role: role.role,
        community_id: role.community_id
      })
    );
  });
```

### 3. **UI Intuitiva con Iconos y Badges**
```typescript
const RoleIcon = ({ role }: { role: UserRole }) => {
  switch (role) {
    case 'admin':
      return <Crown className="h-3.5 w-3.5 text-yellow-600" />;
    case 'manager':
      return <Shield className="h-3.5 w-3.5 text-blue-600" />;
    case 'resident':
      return <User className="h-3.5 w-3.5 text-green-600" />;
  }
};
```

### 4. **Panel de Administraci√≥n Integrado**
```typescript
// /src/app/.../dashboard/AdminQuickActions.tsx
export const AdminQuickActions = () => {
  const { isAdmin, isManager } = usePermissions();

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {isAdmin && (
        <QuickActionCard
          title="Usuarios"
          description="Gestionar usuarios y roles del sistema"
          icon={Users}
          href="/users"
          buttonText="Ver Usuarios"
          badge="Admin"
        />
      )}
    </div>
  );
};
```

### 5. **Formularios Din√°micos con React Hook Form**
```typescript
const { fields, append, remove } = useFieldArray({
  control,
  name: 'roles'
});

// Permitir agregar/quitar m√∫ltiples roles por usuario
const addRole = () => {
  append({ role: 'resident', community_id: null });
};
```

## üé® **Componentes Clave**

### **1. UsersList.tsx**
- Tabla responsive con informaci√≥n de usuarios
- Iconos visuales para roles
- Badges de comunidades asignadas
- Botones de acci√≥n (Editar/Eliminar)

### **2. CreateUserForm.tsx**
- Formulario para email y contrase√±a
- Gesti√≥n din√°mica de roles m√∫ltiples
- Previsualizaci√≥n de permisos
- Validaci√≥n con Zod

### **3. EditUserForm.tsx**
- Edici√≥n de roles sin cambiar credenciales
- Posibilidad de eliminar todos los roles
- Interfaz visual de permisos actuales

### **4. DeleteUserButton.tsx**
- Modal de confirmaci√≥n con advertencias
- Eliminaci√≥n segura de usuario y roles
- Feedback visual del proceso

### **5. AdminQuickActions.tsx**
- Panel de navegaci√≥n r√°pida
- Tarjetas contextuales seg√∫n permisos
- Resumen de roles del usuario actual

## üîê **Seguridad Implementada**

### **Protecci√≥n a Nivel de Server Action**
```typescript
// Solo admin puede gestionar usuarios
await requirePermission('admin');
```

### **UI Condicional**
```typescript
if (!isAdmin) {
  return (
    <Card className="border-destructive">
      <CardTitle className="text-destructive">Acceso Denegado</CardTitle>
    </Card>
  );
}
```

### **Validaci√≥n de Datos**
```typescript
const createUserSchema = z.object({
  email: z.string().email('Debe ser un email v√°lido'),
  password: z.string().min(6, 'Contrase√±a debe tener al menos 6 caracteres'),
  roles: z.array(z.object({
    role: z.enum(['admin', 'manager', 'resident']),
    community_id: z.string().uuid().nullable()
  })).min(1, 'Debe asignar al menos un rol')
});
```

## üß≠ **Rutas Creadas**

| Ruta | Funcionalidad | Acceso |
|------|---------------|--------|
| `/users` | Lista de usuarios | Admin |
| `/users/new` | Crear usuario | Admin |
| `/users/[id]/edit` | Editar roles | Admin |
| `/dashboard` | Panel con navegaci√≥n | Admin/Manager |

## üí° **Conceptos Aprendidos**

### **1. Gesti√≥n de Usuarios en Supabase**
- Uso de `supabase.auth.admin` para crear usuarios
- Sincronizaci√≥n entre `auth.users` y `user_roles`
- Eliminaci√≥n cascada de roles al borrar usuario

### **2. Formularios Complejos con React Hook Form**
- `useFieldArray` para campos din√°micos
- Validaci√≥n en tiempo real con Zod
- Gesti√≥n de estado complejo en formularios

### **3. UI/UX para Administradores**
- Dashboards contextuales seg√∫n roles
- Iconograf√≠a consistente para roles
- Confirmaciones de seguridad para acciones cr√≠ticas

### **4. Arquitectura de Permisos Escalable**
- Middleware reutilizable para autorizaciones
- Server Actions como √∫nica fuente de verdad
- UI que se adapta autom√°ticamente a permisos

## üöÄ **Pr√≥ximos Pasos**

Con la gesti√≥n de usuarios completa, el siguiente paso l√≥gico ser√≠a implementar:

1. **Lecci√≥n 1.5: Sistema de Incidencias**
   - CRUD de tickets por comunidad
   - Estados (abierto/en progreso/cerrado)
   - Asignaci√≥n a managers/residentes

2. **Notificaciones por Email**
   - Avisos de nuevos usuarios creados
   - Cambios de roles
   - Invitaciones a comunidades

3. **Audit Log**
   - Registro de cambios en usuarios
   - Historial de acciones administrativas

## üß™ **C√≥mo Probar**

1. **Acceder como Admin:**
   ```
   http://localhost:3001/dashboard
   ```

2. **Gestionar Usuarios:**
   ```
   http://localhost:3001/users
   ```

3. **Crear Nuevo Usuario:**
   ```
   http://localhost:3001/users/new
   ```

4. **Verificar en Base de Datos:**
   ```sql
   SELECT u.email, ur.role, c.name 
   FROM auth.users u 
   LEFT JOIN user_roles ur ON u.id = ur.user_id 
   LEFT JOIN communities c ON ur.community_id = c.id;
   ```

---

## üèÜ **Lo que hemos implementado:**

‚úÖ **CRUD Completo de Usuarios:**
- **Listar usuarios** (`/users`) con roles y comunidades
- **Crear usuarios** (`/users/new`) con asignaci√≥n de roles
- **Editar roles** (`/users/[id]/edit`) por usuario
- **Eliminar usuarios** con confirmaci√≥n segura

‚úÖ **Sistema de Roles Granular:**
- **Admin:** Acceso global a todo el sistema
- **Manager:** Gesti√≥n por comunidades espec√≠ficas  
- **Resident:** Acceso b√°sico por comunidad

‚úÖ **UI Intuitiva:**
- **Iconos visuales** para cada rol (üëë Admin, üõ°Ô∏è Manager, üë§ Resident)
- **Badges informativos** con colores por rol
- **Formularios din√°micos** para gesti√≥n de roles
- **Panel de administraci√≥n** integrado en dashboard

‚úÖ **Seguridad y Permisos:**
- **Server Actions protegidas** con middleware de autorizaci√≥n
- **Validaci√≥n completa** con Zod schemas
- **UI condicional** seg√∫n permisos del usuario

‚úÖ **Funcionalidades principales:**

### **Para Administradores:**
- Ver y gestionar **todos los usuarios**
- Crear usuarios con **m√∫ltiples roles**
- Asignar usuarios a **comunidades espec√≠ficas**
- **Eliminar usuarios** del sistema

### **Para Managers:**
- Ver **panel de gesti√≥n** con acceso a sus comunidades
- **Acceso controlado** seg√∫n asignaciones

### **Dashboard Integrado:**
- **Navegaci√≥n r√°pida** a todas las funciones
- **Resumen de permisos** del usuario actual
- **Acciones contextuales** seg√∫n el rol